name: Visual Regression Testing

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
      
      - name: Install dependencies
        run: npm ci --prefer-offline
      
      - name: Install Playwright with dependencies
        run: npx playwright install --with-deps chromium
      
      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder-key' }}
      
      - name: Run visual regression tests
        run: npx playwright test tests/e2e/visual-regression.spec.ts
        env:
          CI: true

      
      - name: Upload visual diff artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-diffs
          path: |
            test-results/
            playwright-report/
          retention-days: 30
      
      - name: Comment on PR with visual changes
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üëÅÔ∏è Visual Regression Detected\n\n` +
              `‚ö†Ô∏è Visual changes detected in this PR.\n\n` +
              `Please review the visual diff artifacts to ensure changes are intentional.\n\n` +
              `[View Visual Diffs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  performance-budget:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --prefer-offline
      
      - name: Build project
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder-key' }}

      
      - name: Check performance budgets
        id: budget
        continue-on-error: true
        run: |
          TOTAL_SIZE=$(du -sb dist | cut -f1)
          MAX_SIZE=$((5 * 1024 * 1024)) # 5MB limit (increased)
          
          JS_SIZE=$(find dist/assets -name "*.js" -exec du -sb {} + | awk '{sum+=$1} END {print sum}')
          MAX_JS=$((3 * 1024 * 1024)) # 3MB JS limit (increased)
          
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "js_size=$JS_SIZE" >> $GITHUB_OUTPUT
          echo "max_size=$MAX_SIZE" >> $GITHUB_OUTPUT
          echo "max_js=$MAX_JS" >> $GITHUB_OUTPUT
          
          if [ $TOTAL_SIZE -gt $MAX_SIZE ]; then
            echo "budget_exceeded=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Total bundle size exceeds 5MB budget!"
          fi
          
          if [ $JS_SIZE -gt $MAX_JS ]; then
            echo "js_budget_exceeded=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è JavaScript size exceeds 3MB budget!"
          fi

      
      - name: Comment budget status on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const totalSize = parseInt('${{ steps.budget.outputs.total_size }}');
            const jsSize = parseInt('${{ steps.budget.outputs.js_size }}');
            const maxSize = parseInt('${{ steps.budget.outputs.max_size }}');
            const maxJS = parseInt('${{ steps.budget.outputs.max_js }}');
            
            const totalMB = (totalSize / (1024 * 1024)).toFixed(2);
            const jsMB = (jsSize / (1024 * 1024)).toFixed(2);
            const maxMB = (maxSize / (1024 * 1024)).toFixed(2);
            const maxJSMB = (maxJS / (1024 * 1024)).toFixed(2);
            
            const totalStatus = totalSize <= maxSize ? '‚úÖ' : '‚ùå';
            const jsStatus = jsSize <= maxJS ? '‚úÖ' : '‚ö†Ô∏è';
            
            const comment = `## üéØ Performance Budget Check\n\n` +
              `| Metric | Current | Budget | Status |\n` +
              `|--------|---------|--------|--------|\n` +
              `| üì¶ Total Size | ${totalMB} MB | ${maxMB} MB | ${totalStatus} |\n` +
              `| üìú JavaScript | ${jsMB} MB | ${maxJSMB} MB | ${jsStatus} |\n\n` +
              `${totalSize > maxSize ? '‚ùå **Action Required:** Bundle size exceeds budget!\n\n' : ''}` +
              `${jsSize > maxJS ? '‚ö†Ô∏è **Warning:** JavaScript size is high. Consider code splitting.\n\n' : ''}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
