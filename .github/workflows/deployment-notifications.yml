name: Deployment Notifications

on:
  deployment_status:

jobs:
  notify:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' || github.event.deployment_status.state == 'failure'
    
    steps:
      - name: Get deployment info
        id: deployment-info
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.getDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment.id
            });
            
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: deployment.data.sha
            });
            
            // Find associated PR
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: deployment.data.sha
            });
            
            return {
              environment: deployment.data.environment,
              sha: deployment.data.sha.substring(0, 7),
              message: commit.data.commit.message.split('\n')[0],
              author: commit.data.commit.author.name,
              url: context.payload.deployment_status.environment_url,
              prNumber: prs.data.length > 0 ? prs.data[0].number : null
            };

      - name: Comment on PR (success)
        if: github.event.deployment_status.state == 'success' && fromJSON(steps.deployment-info.outputs.result).prNumber != null
        uses: actions/github-script@v7
        with:
          script: |
            const info = ${{ steps.deployment-info.outputs.result }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: info.prNumber,
              body: `## ✅ Deployment Successful\n\n**Environment:** ${info.environment}\n**Commit:** ${info.sha}\n**Message:** ${info.message}\n**Author:** ${info.author}\n**URL:** ${info.url}\n**Time:** ${new Date().toISOString()}`
            });

      - name: Create deployment status (success)
        if: github.event.deployment_status.state == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const info = ${{ steps.deployment-info.outputs.result }};
            console.log(`✅ Deployment successful: ${info.environment} - ${info.sha}`);
            console.log(`URL: ${info.url}`);

      - name: Comment on PR (failure)
        if: github.event.deployment_status.state == 'failure' && fromJSON(steps.deployment-info.outputs.result).prNumber != null
        uses: actions/github-script@v7
        with:
          script: |
            const info = ${{ steps.deployment-info.outputs.result }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: info.prNumber,
              body: `## ❌ Deployment Failed\n\n**Environment:** ${info.environment}\n**Commit:** ${info.sha}\n**Message:** ${info.message}\n**Author:** ${info.author}\n**Time:** ${new Date().toISOString()}\n\n**Action Required:** Please investigate the deployment failure.`
            });

      - name: Create issue for deployment failure
        if: github.event.deployment_status.state == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const info = ${{ steps.deployment-info.outputs.result }};
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Failed: ${info.environment} - ${info.sha}`,
              body: `## ❌ Deployment Failed\n\n**Environment:** ${info.environment}\n**Commit:** ${info.sha}\n**Message:** ${info.message}\n**Author:** ${info.author}\n**Time:** ${new Date().toISOString()}\n\n**Action Required:** Please investigate the deployment failure.`,
              labels: ['deployment-failure', 'urgent']
            });
